name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint mypy
        pip install -r requirements.txt
        
    - name: Run Black (formatting check)
      run: |
        black --check --diff .
        
    - name: Run Flake8 (linting)
      run: |
        flake8 . --count --statistics --max-line-length=127
        
    - name: Run Pylint
      run: |
        pylint backend/ --exit-zero --output-format=json > pylint-report.json
        
    - name: Run MyPy (type checking)
      run: |
        mypy backend/ --ignore-missing-imports --no-strict-optional || echo "Type checking completed with warnings"
        
    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO and FIXME comments..."
        grep -r "TODO\|FIXME" --include="*.py" --include="*.js" . || echo "No TODO/FIXME found"
        
    - name: Upload quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          pylint-report.json
          
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Check Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit
        pip-audit --desc
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Check Node.js dependencies
      working-directory: ./mobile-app
      run: |
        npm audit --audit-level=moderate
        
  commit-lint:
    name: Commit Message Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional
        
    - name: Validate commit messages
      run: |
        npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
